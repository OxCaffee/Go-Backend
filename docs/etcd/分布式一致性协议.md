# 分布式一致性协议

## 分布式系统设计的目标

1. **可用性** ：核心需求，用于衡量一个分布式系统持续对外提供服务的能力
2. **可扩展性** ：增加机器后不会改变系统的行为，并且能获得性能提升
3. **容错性** ：系统发生错误时，具有对错误进行规避以及从错误中恢复的能力
4. **性能** ：对外服务的响应延时和吞吐率要能满足用户的需求

## CAP原理

* **Consistency(一致性)** ：这里一致性指**强一致性** ，也就是说所有节点的数据时刻保持同步，系统的行为是串行的
* **Availability(可用性)** ：任何非故障节点都应该在有限的时间内给出请求的响应，不论该请求是否成功
* **Tolerance to the partition of network(分区容忍性)** ： 当节点之间发生无法通信的情况的时候，在丢失任意多的消息的情况下，系统仍然能够正常工作

## CAP三者不可兼得

* **AP满足但是C不满足** ：如果要求分区容错，那么一致性就无法保证。因为一旦发生网络通信节点故障，每个节点只能本地提供服务，就无法保证一致性
* **CP满足但是A不满足** ：如果要求强一致，那么可用性就得不到保证
* **CA满足但是P不满足** ：要求强一致性和可用性就必然放弃分区容错

就好像永远不可能发明永动机一样。

## 一致性协议

分布式系统的一致性是一个具备容错能力的分布式系统需要解决的基本问题。而一致性协议就是解决一致性问题的协议。

## 衡量一致性协议的标准

* **可终止性** ：非失败进程在有限时间内能够做出决定
* **一致性** ：所有进程必须对最终的决定达成一致
* **合法性** ：算法做出的决定必须在其他进程的期望值范围之内

## 一致性模型

### 强一致性(Strong Consistency)

强一致性也称原子一致性，**是最严格的一致性模型** ，具体要求如下：

* 任何一次读都能读到该数据最近一次写入的数据
* 系统中任何进程，看到的操作顺序，都与全局时钟下的顺序一致

### 顺序一致性(Sequential Consistency)

顺序一致性也称可序列化，比强一致性弱一点，但是要求也比较高。全局时钟导致一致性很难实现，**顺序一致性改为分布式逻辑时钟实现** 。顺序一致性要求所有的进程都以相同的顺序看到所有的修改，读操作未必能够及时得到此前其他进程对同一数据的写更新，但是每个进程读到的该数据的不同值的顺序是一致的。

满足顺序一致性的存储系统需要一个额外的逻辑时钟服务。

### 因果一致性(Causal Consistency)

* **本地顺序** ：本进程中，事件执行的顺序即为本地因果顺序
* **异地顺序** ：如果读操作返回的是写操作的值，那么该写操作在顺序上一定在读操作之前
* **闭包传递** ：与时钟向量里面定义一样，如果`a->b`，且`b->c`，就一定有`a->c`

### 可串行化一致性(Serializable Consistency)

大致意思就是程序并没有对调用者的调用和完成时间进行限制，但是操作的顺序等同于原子顺序。

### 最终一致性(Eventual Consistency)

放弃强一致性，保证程序的最终一致性。

## FPL不可能性定理

**在异步通信场景下，任何一致性协议都不能保证，即使只有一个进程失败，其他非失败进程能达成一致。** 即任何分布式一致性协议都存在**不可终止性问题** 。而Paxos和Raft都只是通过随机的方式降低了发生不可终止问题的概率。 



